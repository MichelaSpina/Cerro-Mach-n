---
title: "Ritaglio immagini e calcolo indici (semplice)"
author: "MichelaSpina"
date: "2026-01-15"
output: html_document
---

```{r setup, include=FALSE}
# Impostazioni kernel R Markdown
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
```

# Descrizione
Questo documento R Markdown è pensato per essere semplice e facilmente eseguibile in RStudio.  
Fa le seguenti operazioni:
- legge tre raster (Bing, ESRI, Sentinel),
- permette di scegliere un rettangolo di interesse (clic con il mouse) oppure usare coordinate manuali,
- ritaglia e maschera i raster con lo stesso rettangolo,
- estrae le bande Red, NIR, Green e Blue dal Sentinel,
- normalizza automaticamente se le bande sono in scala 0-10000,
- calcola NDVI, SAVI, MSAVI, GCI, LAI, EVI,
- calcola l'entropia di Shannon della distribuzione di EVI e il coefficiente di variazione (CV) di EVI,
- mostra i risultati a video e permette di salvare i risultati.

# Requisiti
Installa i pacchetti necessari:

```{r install-packages, eval=FALSE}
install.packages(c("terra", "viridis"))
```

# 1. Carica pacchetti e imposta i percorsi dei file
setwd()
getwd()
list.files()

```{r load-and-paths}
library(terra)
library(viridis)

# Leggi i raster
r_bing     <- rast("Satellite_HD_Bing_z18.tif")
r_esri     <- rast("Satellite_HD_ESRI_z18.tif")
r_sentinel <- rast("Sentinel-2_20250122.tif")

# Mostra informazioni di base
r_bing
r_esri
r_sentinel
```

# 2. Selezione del rettangolo di interesse (interattiva)
Metodo interattivo: esegui la cella e clicca due punti opposti nella finestra grafica.

```{r select-extent}
# Usa r_bing come base per la selezione (esegui in ambiente interattivo)
plot(r_bing, main = "Clicca due punti opposti per definire il rettangolo")
cat("Clicca PRIMO angolo, poi SECONDO angolo nella finestra grafica\n")
pts <- tryCatch(locator(2), error = function(e) NULL)

if (is.null(pts) || length(pts$x) < 2) {
  stop("Selezione non riuscita. Usa ambiente interattivo.")
}

xmin_ <- min(pts$x); xmax_ <- max(pts$x)
ymin_ <- min(pts$y); ymax_ <- max(pts$y)
e <- ext(xmin_, xmax_, ymin_, ymax_)

# mostra il rettangolo selezionato
rect(xmin_, ymin_, xmax_, ymax_, border = "red", lwd = 2)

# e contiene l'extent selezionata
e
```

# 3. Ritaglio e maschera (usa l'extent selezionata)
Qui ricostruiamo un poligono dalla extent e applichiamo mask dopo il crop.

```{r crop-mask}
# Costruisco poligono dall'extent per ogni raster (uso lo stesso rettangolo)
xy <- cbind(c(xmin(e), xmax(e), xmax(e), xmin(e), xmin(e)),
            c(ymin(e), ymin(e), ymax(e), ymax(e), ymin(e)))

poly_bing   <- vect(list(xy), type = "polygons", crs = crs(r_bing))
poly_esri   <- vect(list(xy), type = "polygons", crs = crs(r_esri))
poly_sentinel <- vect(list(xy), type = "polygons", crs = crs(r_sentinel))

r_bing_sel     <- mask(crop(r_bing, e), poly_bing)
r_esri_sel     <- mask(crop(r_esri, e), poly_esri)
r_sentinel_sel <- mask(crop(r_sentinel, e), poly_sentinel)

# Visualizzo i ritagli
plot(r_bing_sel, main = "Bing ritagliato")
plot(r_esri_sel, main = "ESRI ritagliato")
plot(r_sentinel_sel, main = "Sentinel ritagliato")
```

# 4. Estrai le bande Sentinel
Controlla gli indici delle bande: per i file Sentinel frequentemente red = 4, nir = 8, green = 3, blue = 2. Se il tuo file è diverso, modifica questi numeri.

```{r bands-normalize}
# Indici bande (modifica se il tuo file è diverso)
red_idx   <- 4
nir_idx   <- 8
green_idx <- 3
blue_idx  <- 2

# Verifica che il raster abbia le bande attese
if (nlyr(r_sentinel_sel) < max(red_idx, nir_idx, green_idx, blue_idx)) {
  stop("Il raster Sentinel ritagliato non ha abbastanza bande. Controlla gli indici.")
}

red   <- r_sentinel_sel[[red_idx]]
nir   <- r_sentinel_sel[[nir_idx]]
green <- r_sentinel_sel[[green_idx]]
blue  <- r_sentinel_sel[[blue_idx]]

# Normalizzazione semplice se i valori sono su scala 0-10000
if (global(red, "max", na.rm = TRUE)[[1]] > 1.5) red <- red / 10000
if (global(nir, "max", na.rm = TRUE)[[1]] > 1.5) nir <- nir / 10000
if (global(green, "max", na.rm = TRUE)[[1]] > 1.5) green <- green / 10000
if (global(blue, "max", na.rm = TRUE)[[1]] > 1.5) blue <- blue / 10000
```

# 5. Calcolo indici 

```{r indici}
# NDVI
ndvi <- (nir - red) / (nir + red)
names(ndvi) <- "NDVI"

# SAVI (L = 0.5)
L <- 0.5
savi <- ((nir - red) / (nir + red + L)) * (1 + L)
names(savi) <- "SAVI"

# MSAVI
msavi <- (2 * nir + 1 - sqrt((2 * nir + 1)^2 - 8 * (nir - red))) / 2
names(msavi) <- "MSAVI"

# GCI (Green Chlorophyll Index)
gci <- (nir / green) - 1
names(gci) <- "GCI"

# EVI
evi <- 2.5 * (nir - red) / (nir + 6 * red - 7.5 * blue + 1)
names(evi) <- "EVI"

# LAI 
lai <- 3.618 * ndvi - 0.118
names(lai) <- "LAI"
```

# 6. Calcoli statistici su EVI: Shannon e coeff. di variazione (CV)
Calcolo su tutti i pixel non NA.

```{r stats-evi}
# Estrai valori EVI come vettore e rimuovi NA
evi_vals <- values(evi)
evi_vals <- evi_vals[!is.na(evi_vals)]

# Entropia di Shannon su 50 classi (quanti pixel ci sono in ciascuna classe, quanto è uniforme o vario il tutto)
h <- hist(evi_vals, breaks = 50, plot = FALSE)
p <- h$counts / sum(h$counts)
p_nonzero <- p[p > 0]
shannon_evi <- -sum(p_nonzero * log(p_nonzero))

# Coefficiente di variazione EVI (quanta variabilità c’è rispetto alla media)
evi_mean <- mean(evi_vals) #valore EVI medio di tutta l’area
evi_sd   <- sd(evi_vals) #quanto i valori si allontanano dalla media
evi_cv   <- evi_sd / evi_mean

# Risultati
shannon_evi
evi_mean
evi_sd
evi_cv
```

# 7. Visualizza tutti gli indici
Mostro in plot 

```{r plot-indici}
par(mfrow = c(3,3), mar = c(2,2,2,2))
plot(ndvi, main = "NDVI")
plot(savi, main = "SAVI")
plot(msavi, main = "MSAVI")
plot(gci, main = "GCI")
plot(evi, main = "EVI")
plot(lai, main = "LAI")

# Mostro i valori globali di EVI come testo
plot(r_bing_sel, main = "Statistiche EVI (globali)")
text_x <- xmin(e) + (xmax(e)-xmin(e))*0.02
text_y <- ymin(e) + (ymax(e)-ymin(e))*0.9
text(text_x, text_y,
     labels = paste0("Shannon EVI = ", round(shannon_evi, 3),
                     "\nEVI mean = ", round(evi_mean,3),
                     "\nEVI sd = ", round(evi_sd,3),
                     "\nEVI CV = ", round(evi_cv,3)),
     adj = c(0,0), cex = 0.9)
par(mfrow = c(1,1))
```

# 8. Salvataggio risultati 
Decommenta le righe seguenti se vuoi salvare i raster su disco.

```{r save-outputs, eval=FALSE}
# writeRaster(ndvi, "NDVI.tif", overwrite = TRUE)
# writeRaster(savi, "SAVI.tif", overwrite = TRUE)
# writeRaster(msavi, "MSAVI.tif", overwrite = TRUE)
# writeRaster(gci, "GCI.tif", overwrite = TRUE)
# writeRaster(evi, "EVI.tif", overwrite = TRUE)
# writeRaster(lai, "LAI.tif", overwrite = TRUE)
```
